<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <title>台灣空氣品質監測</title>
    <meta name="viewport" content="width=1024">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue&family=Huninn&display=swap" rel="stylesheet">
    <style>
        body {
            background: #DDE6F1;
            font-family: 'Huninn', sans-serif;
            margin: 0;
        }

        .container {
            display: flex;
            flex-direction: row;
            width: 100vw;
            height: 100vh;
        }

        .left-panel {
            width: 32vw;
            min-width: 320px;
            padding: 40px 0 0 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .title {
            color: #004C5D;
            font-size: 2.4rem;
            font-weight: bold;
            margin-bottom: 16px;
            letter-spacing: 2px;
            font-family: 'Huninn', sans-serif;
        }

        .desc {
            font-size: 1.1rem;
            margin-bottom: 16px;
        }

        .select-group {
            margin-bottom: 16px;
            width: 80%;
        }

        .select-group label {
            display: block;
            margin-bottom: 4px;
            font-size: 1rem;
        }

        .select-group select {
            font-family: 'Huninn', sans-serif;
            width: 100%;
            padding: 6px 8px;
            font-size: 1rem;
            border-radius: 10px;
            border: 1px solid #bbb;
            margin-bottom: 8px;
        }

        .info-box {
            background: #fff;
            border-radius: 16px;
            width: 80%;
            min-height: 160px;
            margin-bottom: 24px;
            padding: 16px;
            box-sizing: border-box;
            box-shadow: 0 2px 8px #0001;
            font-size: 1.1rem;
        }

        .aqi-legend {
            margin-top: 12px;
            width: 80%;
        }

        .aqi-legend-row {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }

        .right-panel {
            flex: 1;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 32px 0 0 0;
        }

        .map-box {
            background: #fff;
            border-radius: 18px;
            width: 90%;
            height: 90vh;
            min-width: 500px;
            min-height: 600px;
            box-shadow: 0 2px 8px #0001;
        }

        .aqi-legend-color-dark {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 200px;
            height: 30px;
            color: #000;
            border-radius: 16px;
        }

        .aqi-legend-color-light {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 200px;
            height: 30px;
            color: #fff;
            border-radius: 16px;
        }

        @media (max-width: 900px) {
            .container {
                flex-direction: column;
            }

            .left-panel,
            .right-panel {
                width: 100vw;
            }

            .map-box {
                width: 98vw;
                min-width: unset;
            }
        }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCOtFePrZLNlGhi04LY08hEkCgPdA3T8Us&libraries=marker&loading=async&callback=initMap" async defer></script>
    <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="left-panel">
            <div class="title">台灣空氣品質監測</div>
            <div class="select-group">
                <label for="county">縣市</label>
                <select id="county"></select>
                <label for="town">地區</label>
                <select id="town"></select>
            </div>
            <div class="info-box" id="infoBox">
                請點選地圖標記或選擇地區
            </div>
            <div class="aqi-legend">
                <div class="aqi-legend-row"><span style="margin-right: 60px;">0-50</span><span
                        class="aqi-legend-color-dark" style="background:#2AE32D">良好</span></div>
                <div class="aqi-legend-row"><span style="margin-right: 40px">51-100</span><span
                        class="aqi-legend-color-dark" style="background:#FCFC4F">普通</span></div>
                <div class="aqi-legend-row"><span style="margin-right: 30px">101-150</span><span
                        class="aqi-legend-color-dark" style="background:#FD932A">對敏感族群不健康</span></div>
                <div class="aqi-legend-row"><span style="margin-right: 30px">151-200</span><span
                        class="aqi-legend-color-light" style="background:#F53C3F">對所有族群不健康</span></div>
                <div class="aqi-legend-row"><span style="margin-right: 30px">201-300</span><span
                        class="aqi-legend-color-light" style="background:#8C43AF">非常不健康</span></div>
                <div class="aqi-legend-row"><span style="margin-right: 30px">301-500</span><span
                        class="aqi-legend-color-light" style="background:#862011">危害</span></div>
            </div>
        </div>
        <div class="right-panel">
            <div class="map-box" id="map"></div>
        </div>
    </div>
    <script>
        // 取得 infoBox, 縣市與地區下拉選單的 DOM 元素
        const infoBox = document.getElementById('infoBox');
        const countySelect = document.getElementById('county');
        const townSelect = document.getElementById('town');
        let map, markers = [], markerCluster, allData = [];

        // 根據 AQI 數值回傳對應的顏色
        function getAqiColor(aqi) {
            aqi = parseInt(aqi, 10);
            if (aqi <= 50) return '#2AE32D';
            if (aqi <= 100) return '#FCFC4F';
            if (aqi <= 150) return '#FD932A';
            if (aqi <= 200) return '#F53C3F';
            if (aqi <= 300) return '#8C43AF';
            return '#862011';
        }

        // 顯示測站詳細資訊於 infoBox
        function showInfoBox(data) {
            infoBox.innerHTML = `
            <div><b>測站名稱：</b>${data.sitename}</div>
            <div><b>縣市：</b>${data.county}</div>
            <div><b>空氣品質指標：</b>${data.aqi}</div>
            <div><b>狀態：</b>${data.status}</div>
            <div><b>資料發布時間：</b>${data.publishtime}</div>
            <div><b>經度：</b>${data.longitude}</div>
            <div><b>緯度：</b>${data.latitude}</div>
        `;
        }

        // 根據選擇的縣市，更新地區下拉選單的選項
        function updateTownOptions(county) {
            // 取得該縣市所有測站名稱（地區）
            const towns = Array.from(new Set(allData.filter(d => d.county === county).map(d => d.sitename)));
            townSelect.innerHTML = `<option value="">全部地區</option>` + towns.map(t => `<option value="${t}">${t}</option>`).join('');
        }

        // 根據選擇的縣市與地區，篩選並顯示地圖上的標記
        function filterMarkers() {
            const county = countySelect.value;
            const town = townSelect.value;
            // 先移除所有標記
            markers.forEach(m => m.map = null); // AdvancedMarkerElement移除方式
            markers = [];
            let filtered = allData;
            // 依縣市與地區篩選資料
            if (county) filtered = filtered.filter(d => d.county === county);
            if (town) filtered = filtered.filter(d => d.sitename === town);
            // 為每筆資料建立地圖標記
            filtered.forEach(d => {
                if (!d.latitude || !d.longitude) return;
                const marker = new google.maps.marker.AdvancedMarkerElement({
                    map,
                    position: { lat: parseFloat(d.latitude), lng: parseFloat(d.longitude) },
                    content: (() => {
                        // 標記樣式：圓形，顏色依 AQI
                        const div = document.createElement('div');
                        div.style.width = '24px';
                        div.style.height = '24px';
                        div.style.borderRadius = '50%';
                        div.style.background = getAqiColor(d.aqi);
                        div.style.border = '2px solid #fff';
                        return div;
                    })()
                });
                // 點擊標記顯示 infoBox
                marker.addListener('click', () => showInfoBox(d));
                markers.push(marker);
            });
            // 清除舊的群組標記
            if (markerCluster) markerCluster.clearMarkers();
            // 若有標記則建立群組
            if (markers.length > 0) {
                markerCluster = new markerClusterer.MarkerClusterer({ map, markers });
            }
        }

        // Google Maps API 會自動呼叫這個函式，初始化地圖
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 23.7, lng: 121 },
                zoom: 7,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false,
                mapId: 'DEMO_MAP_ID'
            });

            // 從後端 API 取得 AQI 資料，並初始化下拉選單與地圖標記
            fetch('https://taiwan-aqi-backend.onrender.com/api/aqi').then(r => r.json()).then(data => {
                allData = data;
                // 取得所有縣市選項
                const counties = Array.from(new Set(data.map(d => d.county)));
                countySelect.innerHTML = `<option value="">全部縣市</option>` + counties.map(c => `<option value="${c}">${c}</option>`).join('');
                // 監聽縣市選擇變更
                countySelect.addEventListener('change', () => {
                    updateTownOptions(countySelect.value);
                    filterMarkers();
                    infoBox.innerHTML = '請點選地圖標記或選擇地區';
                });
                // 監聽地區選擇變更
                townSelect.addEventListener('change', () => {
                    filterMarkers();
                    const town = townSelect.value;
                    if (town) {
                        // 顯示該地區的 infoBox
                        const d = allData.find(d => d.sitename === town && d.county === countySelect.value);
                        if (d) showInfoBox(d);
                    } else {
                        infoBox.innerHTML = '請點選地圖標記或選擇地區';
                    }
                });
                // 預設初始化地區選項與標記
                updateTownOptions(countySelect.value);
                filterMarkers();
            });
        }
        // 讓 Google Maps API 能呼叫 initMap
        window.initMap = initMap;
    </script>
</body>

</html>